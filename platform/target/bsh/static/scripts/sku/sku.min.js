(function(a){var b=a.$Sku;var c={define:function(){var f=Ext.create("Ext.data.Store",{fields:["value","label"],proxy:{type:"ajax",url:path("/sku/findBrand.json"),reader:{type:"json",root:"result"}},autoLoad:true});var e=Ext.create("Ext.data.Store",{fields:["value","label"],proxy:{type:"ajax",url:path("/sku/findCategory.json"),reader:{type:"json",root:"result"}},autoLoad:true});Ext.define("Smartec.sku.SkuGrid",{extend:"Smartec.grid.Panel",model:"Sku",id:"skuGridId",height:"100%",width:"100%",columns:[{xtype:"rownumberer",text:"序号",width:40,sortable:false},{text:"id",dataIndex:"id",hidden:true},{text:"version",dataIndex:"version",hidden:true},{text:"品牌",width:160,sortable:true,dataIndex:"brand"},{text:"品类",width:160,sortable:true,dataIndex:"cid"},{text:"SKU号",width:150,sortable:true,dataIndex:"matnr"},{text:"Tmall价格",width:130,sortable:true,dataIndex:"tmallPrice"},{text:"Sap价格",width:130,sortable:true,dataIndex:"sapprice"},{text:"状态",width:130,sortable:true,dataIndex:"status"}],addSku:function(g){return function(){Ext.Ajax.request({url:path("/sku/doCurrentOperation.json?operationType=save"),method:"post",dataType:"json",success:function(k,h){var j=Ext.decode(k.responseText);if(j.success){var i=g.up("gridpanel");if(Ext.getCmp("addSkuWindow")){Ext.getCmp("addSkuWindow").show(this)}else{Ext.create("Ext.Window",{title:"添加SKU",width:450,height:300,layout:"fit",draggable:true,maximizable:true,modal:true,id:"addSkuWindow",listeners:{hide:function(m){var l=Ext.getCmp("addSkuForm").getForm();l.clearInvalid();l.reset()}},items:[new Ext.form.FormPanel({id:"addSkuForm",bodyPadding:20,autoScroll:true,items:[{xtype:"combo",fieldLabel:"品牌",name:"brand",store:f,displayField:"label",valueField:"value",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,queryMode:"local",forceSelection:true,typeAhead:true,listeners:{beforequery:function(o){var n=o.combo;if(!o.forceAll){var l=o.query;var m=new RegExp(".*"+l+".*");n.store.filterBy(function(p,r){var q=p.get(n.displayField);return m.test(q)});n.expand();return false}}}},{xtype:"combo",fieldLabel:"品类",typeAhead:true,name:"category",store:e,displayField:"label",valueField:"value",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,queryMode:"local",forceSelection:true,typeAhead:true,listeners:{beforequery:function(o){var n=o.combo;if(!o.forceAll){var l=o.query;var m=new RegExp(".*"+l+".*");n.store.filterBy(function(p,r){var q=p.get(n.displayField);return m.test(q)});n.expand();return false}}}},{xtype:"textfield",fieldLabel:"型号",name:"matnr",id:"matnr",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",maxLength:50,maxLengthText:"最大长度不能超过50个字符!",width:300,regex:/^[A-Za-z0-9]+$/,regexText:"错误,SKU号只能由数字和字母组成",listeners:{blur:function(){var l=Ext.getCmp("matnr").getValue();Ext.Ajax.request({url:path("/sku/findMatnr.json?inputMatnr="+l),method:"post",dataType:"json",success:function(o,m){var n=Ext.decode(o.responseText);if(n.success){}else{Ext.Msg.alert("提示信息","SKU号错误:"+n.result);Ext.getCmp("matnr").setValue()==""}},failure:function(n,m){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})}}},{xtype:"numberfield",fieldLabel:"TMALL 价格",name:"tmallprice",allowDecimals:true,decimalPrecision:2,allowBlank:false,blankText:"不能为空",minValue:0,padding:"0 0 10 0"},{fieldLabel:"SAP 价格",xtype:"numberfield",name:"sapprice",allowBlank:false,blankText:"不能为空",allowDecimals:true,decimalPrecision:2,minValue:0,padding:"0 0 10 0"},{xtype:"button",text:"保存",iconCls:"icon-ok",handler:g.saveSku}]})]}).show()}Ext.getCmp("addSkuWindow").on("close",function(){Ext.Ajax.request({url:path("/sku/doDeleteCurrentOperation.json?operationType=save"),method:"post",dataType:"json",success:function(m,l){}})})}else{Ext.Msg.alert("提示信息",j.result)}}})}},saveSku:function(){var g=Ext.getCmp("addSkuForm").getForm();if(g.isValid()){g.submit({url:path("/sku/saveSku.json?"),method:"POST",success:function(j,i){Ext.Msg.alert("提示信息","保存成功");Ext.getCmp("addSkuWindow").close();var h=Ext.getCmp("skuGridId");h.getStore().load()},failure:function(j,i){var h=Ext.decode(i.response.responseText);Ext.Msg.alert("提示信息","保存失败:"+h.result)},waitTitle:Ext.MessageBox.wait("正在保存，请等待...","提示")})}else{Ext.Msg.alert("提示信息","请输入正确的值！")}},deleteSku:function(k){var j=this.up("gridpanel");var m=j.getSelectionModel();var g=m.getSelection();if(!(g.length>=1)){Ext.Msg.alert("错误","没有任何行被选中，无法进行删除操作！");return}var l="";for(var h=0;h<g.length;h++){l=l+g[h].data.id+";"}Ext.Ajax.request({url:path("/sku/doCurrentOperation.json?operationType=delete&id="+l),method:"post",dataType:"json",success:function(p,i){var n=Ext.decode(p.responseText);if(n.success){Ext.MessageBox.confirm({title:"警告",msg:"确定要删除吗?",closable:false,buttons:Ext.Msg.YESNO,fn:o,icon:Ext.Msg.INFO});function o(q){if(q=="yes"){Ext.Ajax.request({url:path("/sku/deleteSku.json?id="+l),method:"post",success:function(t,s){Ext.Msg.alert("提示信息","删除成功");var r=Ext.getCmp("skuGridId");r.getStore().load()},failure:function(s,r){Ext.Msg.alert("提示信息","删除失败")},waitTitle:Ext.MessageBox.wait("正在保存，请等待...","提示")})}else{if(q=="no"){Ext.Ajax.request({url:path("/sku/doDeleteCurrentOperation.json?operationType=delete"),method:"post",dataType:"json",success:function(s,r){}})}}}}else{Ext.Msg.alert("提示信息",n.result)}},failure:function(n,i){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})},modifySku:function(k){var j=this.up("gridpanel");var l=j.getSelectionModel();var i=l.getSelection();if(i.length==0){Ext.Msg.alert("提示","请选择一条记录进行修改！");return}if(i.length!=1){Ext.Msg.alert("提示","只能选择一条记录进行修改！");return}var h=l.getSelection()[0];var g=h.get("id");Ext.Ajax.request({url:path("/sku/doCurrentOperation.json?operationType=modify&sysId="+g),method:"post",dataType:"json",success:function(o,m){var n=Ext.decode(o.responseText);if(n.success){if(Ext.getCmp("editSkuWindow")){Ext.getCmp("editSkuWindow").show()}else{Ext.create("Ext.Window",{title:"修改SKU",width:450,height:300,layout:"fit",draggable:true,maximizable:true,modal:true,id:"editSkuWindow",items:[Ext.create("Ext.form.Panel",{url:path("/sku/findById.json?id="+g),id:"editSkuForm",reader:new Ext.data.JsonReader({root:"result",model:"Sku",successProperty:"success"}),bodyPadding:20,items:[{xtype:"combo",fieldLabel:"品牌",id:"brandCom",name:"brand",store:f,displayField:"label",valueField:"value",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,value:h.get("brand"),queryMode:"local",forceSelection:true,typeAhead:true,listeners:{beforequery:function(s){var r=s.combo;if(!s.forceAll){var p=s.query;var q=new RegExp(".*"+p+".*");r.store.filterBy(function(t,v){var u=t.get(r.displayField);return q.test(u)});r.expand();return false}}}},{xtype:"combo",fieldLabel:"品类",typeAhead:true,id:"category",name:"category",store:e,displayField:"label",valueField:"value",value:h.get("cid"),queryMode:"local",forceSelection:true,typeAhead:true,padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,listeners:{beforequery:function(s){var r=s.combo;if(!s.forceAll){var p=s.query;var q=new RegExp(".*"+p+".*");r.store.filterBy(function(t,v){var u=t.get(r.displayField);return q.test(u)});r.expand();return false}}}},{xtype:"textfield",fieldLabel:"型号",id:"matnr",name:"matnr",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",value:h.get("matnr"),maxLength:50,maxLengthText:"最大长度不能超过50个字符!",width:300,regex:/^[A-Za-z0-9]+$/,regexText:"错误,SKU号只能由数字和字母组成",listeners:{blur:function(){var q=Ext.getCmp("matnr").getValue();var p=h.get("matnr");Ext.Ajax.request({url:path("/sku/findMatnrRemoveMy.json?inputMatnr="+q+"&recordMantr="+p),method:"post",dataType:"json",success:function(t,r){var s=Ext.decode(t.responseText);if(s.success){}else{Ext.Msg.alert("提示信息","SKU号错误:"+s.result)}},failure:function(s,r){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})}}},{xtype:"numberfield",fieldLabel:"TMALL 价格",name:"tmallprice",value:h.get("tmallPrice"),allowDecimals:true,decimalPrecision:2,minValue:0,padding:"0 0 10 0",filter:{type:"numeric"}},{fieldLabel:"SAP 价格",xtype:"numberfield",name:"sapprice",value:h.get("sapprice"),allowDecimals:true,decimalPrecision:2,minValue:0,padding:"0 0 10 0",filter:{type:"numeric"}},{xtype:"fieldcontainer",layout:"hbox",items:[{xtype:"button",text:"保存",iconCls:"icon-ok",handler:function(){var q=Ext.getCmp("editSkuForm").getForm();var p=h.get("matnr");if(this.up("panel").getForm().isValid()){this.up("panel").getForm().submit({url:path("/sku/saveSku.json?id="+g+"&recordMantr="+p),success:function(t,s){Ext.Msg.alert("提示信息","保存成功");Ext.getCmp("editSkuWindow").close();var r=Ext.getCmp("skuGridId");r.getStore().load()},failure:function(u,t){var s=Ext.decode(t.response.responseText);Ext.Msg.alert("提示信息","保存失败:"+s.result);if("该记录已被删除"==s.result){Ext.getCmp("editSkuWindow").close();var r=Ext.getCmp("skuGridId");r.getStore().load()}},waitTitle:Ext.MessageBox.wait("正在保存，请等待...","提示")})}else{Ext.Msg.alert(messages["ext.tips.error"],"填写的内容有误!")}}}]}]})]}).show()}Ext.getCmp("editSkuWindow").on("close",function(){Ext.Ajax.request({url:path("/sku/doDeleteCurrentOperation.json?operationType=modify&sysId="+g),method:"post",dataType:"json",success:function(q,p){}})})}else{Ext.Msg.alert("提示信息",n.result)}},failure:function(n,m){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})},unlockSku:function(g){Ext.Ajax.request({url:path("/sku/doDeleteSkuCurrentOperationByUser.json"),method:"post",dataType:"json",success:function(j,h){var i=Ext.decode(j.responseText);Ext.Msg.alert("提示信息",i.result)}})},initComponent:function(){var g=this;g.topDockedItems=[{xtype:"button",itemId:"btnSearch",height:24,text:"重置查询",iconCls:"icon-edit",handler:c.clearFilters()},{xtype:"button",itemId:"btnAdd",height:24,text:"添加",iconCls:"icon-edit",handler:g.addSku(this)},{xtype:"button",itemId:"btnEdit",height:24,text:"修改",disable:true,iconCls:"icon-edit",handler:g.modifySku},{xtype:"button",itemId:"btnDelete",height:24,text:"删除",disable:true,iconCls:"icon-edit",handler:g.deleteSku},{xtype:"button",itemId:"btnUnlocek",height:24,text:"解锁",disable:true,iconCls:"icon-edit",handler:g.unlockSku}];g.callParent();g.getSelectionModel().on("selectionchange",function(i,h){})}})},clearFilters:function(){var e=this;return function(){if(e.sku_grid){e.sku_grid.filters.clearFilters()}}},init_filters:function(){return[{type:"string",dataIndex:"brand"},{type:"string",dataIndex:"cid"},{type:"string",dataIndex:"matnr"},{type:"numeric",dataIndex:"tmallPrice"},{type:"numeric",dataIndex:"sapprice"},{type:"string",dataIndex:"status"},{type:"numeric",dataIndex:"version"}]},create_grid:function(){if(!this.sku_grid){this.sku_grid=Ext.create("Smartec.sku.SkuGrid",{topBarHight:30,id:"skuGridId",autoHeight:true,autoWidth:true,autoAdded:false,autoSetStore:true,features:[{ftype:"filters",encode:true,local:false,menuFilterText:messages["ext.filters.menuFilterText"],filters:c.init_filters()}]})}return this.sku_grid}};function d(){c.define();var e={createGrid:function(){return c.create_grid()}};return e}a.$Sku=d()})(this);Ext.onReady(function(){var a=$Sku.createGrid();Ext.getCmp("center").add(a)});
(function(c){var a=c.$User;var d={define:function(){Ext.define("Oms.User.Index",{id:"userGridPanel",alias:"widget.usergrid",extend:"Smartec.grid.Panel",model:"User",columns:[{xtype:"rownumberer",text:"序号",width:40,sortable:false},{text:"id",dataIndex:"userSysId",hidden:true},{text:"用户名",width:100,sortable:false,dataIndex:"userId"},{text:"电子邮件",width:200,sortable:false,dataIndex:"userEmail"},{text:"昵称",width:200,sortable:false,dataIndex:"userName"},{text:"角色",width:200,sortable:false,dataIndex:"userRoles"},{text:"状态",width:100,sortable:false,dataIndex:"userStatus",renderer:function(e){return e=="1"?"启用":"禁用"}}],addUserHandle:function(e){return function(){var f=e.up("gridpanel");if(Ext.getCmp("addUserWindow")){Ext.getCmp("addUserWindow").show(this)}else{Ext.create("Ext.Window",{title:"添加用户",width:700,height:400,layout:"fit",draggable:false,maximizable:true,modal:true,id:"addUserWindow",listeners:{hide:function(h){var g=Ext.getCmp("allform").getForm();g.clearInvalid();g.reset()}},closeAction:"hide",items:[allform=new Ext.form.FormPanel({id:"allform",bodyPadding:20,autoScroll:true,items:[{fieldLabel:"用户名<span style=color:red>*</span>",xtype:"textfield",id:"userId",name:"userId",readOnlyCls:"disable",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,maxLength:50,maxLengthText:"最大长度不能超过50个字符!"},{fieldLabel:"电子邮件<span style=color:red>*</span>",xtype:"textfield",id:"userEmail",name:"userEmail",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,maxLength:50,maxLengthText:"最大长度不能超过50个字符!",regex:/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,regexText:"邮箱格式错误"},{fieldLabel:"用户密码<span style=color:red>*</span>",xtype:"textfield",id:"userPassword",name:"userPassword",inputType:"password",allowBlank:false,blankText:"不能为空",width:300,maxLength:16,maxLengthText:"最大长度不能超过16个字符",minLength:6,minLengthText:"最小长度不能小于6个字符",regex:new RegExp("^(?:(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*[^A-Za-z0-9])).{6,16}$"),invalidText:"密码必须包含大小写字母、数字以及特殊字符且长度为6-16位"},{fieldLabel:"确认密码<span style=color:red>*</span>",xtype:"textfield",id:"userPassWordConfirm",name:"userPassWordConfirm",inputType:"password",allowBlank:false,width:300,vtype:"password",vtypeText:"两次密码不一致",confirmTo:"userPassword"},{fieldLabel:"角色(可多选)",xtype:"combo",id:"userRole",name:"userRole",store:Ext.create("Role"),width:500,displayField:"ccRoleName",valueField:"ccRoleSysId",editable:false,padding:"0 0 10 0",multiSelect:true,autoShow:true},{fieldLabel:"昵称",xtype:"textfield",id:"userName",name:"userName",padding:"0 0 10 0",width:300,maxLength:50,maxLengthText:"最大长度不能超过50个字符!"},{fieldLabel:"备注",xtype:"textarea",id:"userRemark",name:"userRemark",width:600,height:100,maxLength:300,maxLengthText:"客户描述的长度不能超过300字符",padding:"0 0 10 0"},{xtype:"displayfield",hidden:true,id:"statusValue",name:"userStatus"},{xtype:"fieldcontainer",fieldLabel:"状态",width:300,defaultType:"radiofield",padding:"0 0 10 0",defaults:{flex:1},layout:"hbox",items:[{boxLabel:"启用",name:"size",inputValue:"1",id:"userStatusRadio1",checked:true},{boxLabel:"禁用",name:"size",inputValue:"0",id:"userStatusRadio2"}]},{xtype:"button",text:"保存",iconCls:"icon-ok",handler:e.saveUser}]})]}).show(this)}}},saveUser:function(){if(allform.form.isValid()){var i=this.up("gridpanel");var h=Ext.getCmp("userId").getValue();var k=Ext.getCmp("userEmail").getValue();var j=Ext.getCmp("userPassword").getValue();var g=Ext.getCmp("userRole").getValue();var l=Ext.getCmp("userName").getValue();var e=Ext.getCmp("userRemark").getValue();var f="";if(Ext.getCmp("userStatusRadio1").getValue()){f=Ext.getCmp("userStatusRadio1").inputValue}else{f=Ext.getCmp("userStatusRadio2").inputValue}Ext.Ajax.request({url:path("/user/saveUser.do"),params:{userId:h,userEmail:k,userPassword:j,userRole:g,userName:l,userRemark:e,size:f},success:function(m){var n=Ext.decode(m.responseText);if(n.result=="UserIdError"){Ext.Msg.alert(messages["ext.tips.error"],"用户id已存在！");return}else{if(n.result=="UserEmailError"){Ext.Msg.alert(messages["ext.tips.error"],"邮箱已存在！");return}else{if(n.success){Ext.Msg.alert(messages["ext.tips.tip"],"添加成功！",function(o){Ext.getCmp("addUserWindow").hide();Ext.getCmp("userGridPanel").store.loadPage(1)})}}}},failure:function(){Ext.Msg.alert(messages["ext.tips.error"],messages["ext.tips.errorMsg"])}})}else{Ext.Msg.alert(messages["ext.tips.error"],"填写的内容有误！")}},refreshUser:function(){return function(){var e=this;e.setDisabled(true);Ext.Ajax.request({url:path("/userRole/refresh"),success:function(){Ext.Msg.alert(messages["ext.tips.error"],"操作成功");e.setDisabled(false)},failure:function(){Ext.Msg.alert(messages["ext.tips.error"],"服务器繁忙，请稍候再试");e.setDisabled(false)}})}},editUserHandle:function(){var g=this.up("gridpanel");var l=g.getSelectionModel();var f=l.getSelection()[0];var e=f.get("userSysId");var i=f.get("userSysId");var k=f.get("userPassword");var j=false;if(Ext.getCmp("editUserWindow")){Ext.getCmp("editUserWindow").show(this)}else{Ext.create("Ext.Window",{title:"修改用户",width:700,height:400,layout:"fit",draggable:false,maximizable:true,modal:true,id:"editUserWindow",items:[orderDetailTabPanel=Ext.create("Ext.panel.Panel",{autoScroll:true,border:0,items:[Ext.create("Ext.panel.Panel",{layout:"fit",items:[Ext.create("Ext.form.Panel",{id:"updateUser",reader:new Ext.data.JsonReader({root:"result",model:"User",successProperty:"success"}),bodyPadding:20,border:0,items:[{fieldLabel:"用户名",xtype:"displayfield",id:"userId"+e,name:"userId",readOnly:true,readOnlyCls:"disable",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,maxLength:50,maxLengthText:"最大长度不能超过50个字符!"},{fieldLabel:"电子邮件",xtype:"textfield",id:"userEmail"+e,name:"userEmail",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,maxLength:50,maxLengthText:"最大长度不能超过50个字符!",regex:/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,regexText:"邮箱格式错误"},{fieldLabel:"操作",xtype:"checkbox",hideLable:true,name:"operatPwd",boxLabel:"同时修改密码",listeners:{change:function(){if(this.checked){Ext.getCmp("userPassword"+e).show();Ext.getCmp("userPassWordConfirm"+e).show();Ext.getCmp("userPassword"+e).allowBlank=false;Ext.getCmp("userPassWordConfirm"+e).allowBlank=false;j=true}else{Ext.getCmp("userPassword"+e).setValue("");Ext.getCmp("userPassWordConfirm"+e).setValue("");Ext.getCmp("userPassword"+e).hide();Ext.getCmp("userPassWordConfirm"+e).hide();Ext.getCmp("userPassword"+e).allowBlank=true;Ext.getCmp("userPassWordConfirm"+e).allowBlank=true;j=false}}}},{fieldLabel:"用户密码<span style=color:red>*</span>",xtype:"textfield",id:"userPassword"+e,name:"userPassword",hidden:true,allowBlank:true,inputType:"password",width:300,maxLength:16,maxLengthText:"最大长度不能超过16个字符",minLength:6,minLengthText:"最小长度不能小于6个字符",regex:new RegExp("^(?:(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*[^A-Za-z0-9])).{6,16}$"),invalidText:"密码必须包含大小写字母、数字以及特殊字符且长度为6-16位"},{fieldLabel:"确认密码<span style=color:red>*</span>",xtype:"textfield",id:"userPassWordConfirm"+e,name:"userPassWordConfirm",inputType:"password",hidden:true,allowBlank:true,width:300,vtype:"password",vtypeText:"两次密码不一致",confirmTo:"userPassword"+e},{xtype:"displayfield",hidden:true,id:"userRoleValue"+e,name:"userRoles"},{fieldLabel:"角色(可多选)",xtype:"combo",id:"userRole"+e,name:"userRole",store:Ext.create("Role"),width:500,displayField:"ccRoleName",valueField:"ccRoleSysId",editable:false,padding:"0 0 10 0",multiSelect:true,queryMode:"local"},{fieldLabel:"昵称",xtype:"textfield",id:"userName"+e,name:"userName",padding:"0 0 10 0",width:300,maxLength:50,maxLengthText:"最大长度不能超过50个字符!"},{fieldLabel:"备注",xtype:"textarea",id:"userRemark"+e,name:"userRemark",width:600,height:100,maxLength:300,maxLengthText:"客户描述的长度不能超过300字符",padding:"0 0 10 0",name:"userRemark"},{xtype:"displayfield",hidden:true,id:"statusValue"+e,name:"customerStatus"},{xtype:"fieldcontainer",fieldLabel:"状态",width:300,defaultType:"radiofield",padding:"0 0 10 0",defaults:{flex:1},layout:"hbox",items:[{boxLabel:"启用",name:"size"+e,inputValue:"1",id:"userStatusRadio1"+e,checked:true},{boxLabel:"禁用",name:"size"+e,inputValue:"0",id:"userStatusRadio2"+e}]},{xtype:"fieldcontainer",layout:"hbox",items:[{xtype:"button",text:"保存",iconCls:"icon-ok",handler:function(){var m=Ext.getCmp("updateUser").getForm();if(this.up("panel").getForm().isValid()){this.up("panel").getForm().submit({url:path("/user/saveUser.do?cbModifyPass="+j+"&userSysId="+e),success:function(n,p){var o=p.result;if(o.result=="UserIdError"){Ext.Msg.alert(messages["ext.tips.error"],"用户id已存在！");return}else{if(o.result=="UserEmailError"){Ext.Msg.alert(messages["ext.tips.error"],"邮箱已存在！");return}else{Ext.Msg.alert(messages["ext.tips.tip"],"修改成功！");g.getStore().load();Ext.getCmp("editUserWindow").close()}}},failure:function(){Ext.Msg.alert(messages["ext.tips.error"],messages["ext.tips.errorMsg"])}})}else{Ext.Msg.alert(messages["ext.tips.error"],"填写的内容有误!")}}}]}]})]})]})]}).show();var h=Ext.getCmp("updateUser").getForm();h.load({url:path("/user/form.json?userSysId="+e),success:function(p,r){p.url=path("/user/saveUser.do?userSysId="+e);var n=Ext.getCmp("userRoleValue"+e).getValue();var o=n.split(",");var q=Ext.getCmp("userRole"+e);q.setValue(o);var m=r.result.data.userStatus;var t=Ext.getCmp("userStatusRadio1"+e);var s=Ext.getCmp("userStatusRadio2"+e);if(m=="1"){t.setValue(true)}else{s.setValue(true)}}})}},removeUserHandle:function(){var g=this.up("gridpanel");var j=g.getSelectionModel();var e=j.getSelection();if(e.length==0){Ext.Msg.alert("错误","没有任何行被选中，无法进行删除操作！");return}var h="";for(var f=0;f<e.length;f++){h+=e[f].data.userSysId+";"}Ext.MessageBox.confirm("警告","确定删除？",function(i){if(i=="yes"){Ext.Ajax.request({url:path("/user/remove.json?id="+h),method:"post",success:function(l,k){Ext.Msg.alert("提示信息","删除成功");Ext.getCmp("userGridPanel").store.loadPage(1)},failure:function(l,k){Ext.Msg.alert("提示信息","删除失败")},waitMsg:Ext.MessageBox.wait("正在删除数据，请等待...","提示")})}})},initComponent:function(){orderGridMe=this;var e=this;e.topDockedItems=[{xtype:"button",itemId:"btnAdd",height:24,text:"添加用户",iconCls:"icon-new",handler:e.addUserHandle(this)},{xtype:"button",itemId:"btnEdit",disabled:true,height:24,text:"修改用户",iconCls:"icon-edit",handler:e.editUserHandle},{xtype:"button",itemId:"btnDelete",height:24,text:"删除用户",iconCls:"icon-delete",handler:e.removeUserHandle}];e.callParent();e.getSelectionModel().on("selectionchange",function(g,f){e.down("#btnEdit").setDisabled(!(f.length==1))});Ext.apply(Ext.form.VTypes,{password:function(h,g){if(g.confirmTo){var f=Ext.getCmp(g.confirmTo);return(h==f.getValue())}return true}})}})},init_filters:function(){return[{type:"string",dataIndex:"userId"}]},create_index:function(){var e=this;return Ext.create("Oms.User.Index",{topBarHight:30,autoSetStore:true,features:[{ftype:"filters",encode:true,local:false,menuFilterText:messages["ext.filters.menuFilterText"],filters:e.init_filters()}]})}};function b(){d.define();var e={createIndex:function(){return d.create_index()}};return e}c.$User=b()})(this);Ext.onReady(function(){var a=$User.createIndex();Ext.getCmp("center").add(a)});
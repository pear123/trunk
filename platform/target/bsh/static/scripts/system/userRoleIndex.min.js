(function(c){var a=c.$UserRole;var d={define:function(){Ext.define("TreeForm",{extend:"Ext.data.Model",fields:[{name:"description",type:"string"},{name:"text",type:"string"},{name:"code",type:"string"},{name:"type",type:"string"},{name:"url",type:"string"},{name:"parentId",type:"string"},{name:"id",type:"string"},{name:"url",type:"string"},{name:"resourceIds",type:"string"}],proxy:{type:"memory",reader:{type:"json"}}});this.resourceFields=[{name:"parentId",type:"string",defaultValue:null},{name:"index",type:"int",defaultValue:null,persist:false},{name:"depth",type:"int",defaultValue:0,persist:false},{name:"expanded",type:"bool",defaultValue:false,persist:false},{name:"expandable",type:"bool",defaultValue:true,persist:false},{name:"checked",type:"auto",defaultValue:null,persist:false},{name:"leaf",type:"bool",defaultValue:false},{name:"cls",type:"string",defaultValue:null,persist:false},{name:"iconCls",type:"string",defaultValue:null,persist:false},{name:"icon",type:"string",defaultValue:null,persist:false},{name:"root",type:"boolean",defaultValue:false,persist:false},{name:"isLast",type:"boolean",defaultValue:false,persist:false},{name:"isFirst",type:"boolean",defaultValue:false,persist:false},{name:"allowDrop",type:"boolean",defaultValue:true,persist:false},{name:"allowDrag",type:"boolean",defaultValue:true,persist:false},{name:"loaded",type:"boolean",defaultValue:false,persist:false},{name:"loading",type:"boolean",defaultValue:false,persist:false},{name:"href",type:"string",defaultValue:null,persist:false},{name:"hrefTarget",type:"string",defaultValue:null,persist:false},{name:"qtip",type:"string",defaultValue:null,persist:false},{name:"qtitle",type:"string",defaultValue:null,persist:false},{name:"children",type:"auto",defaultValue:null,persist:false},{name:"description",type:"string"},{name:"text",type:"string"},{name:"code",type:"string"},{name:"type",type:"string"},{name:"id",type:"string"},{name:"url",type:"string"}]},create_menu:function(e){this.context_menu=Ext.create("Ext.menu.Menu",{items:[{iconCls:"buy-button",text:"删除",id:"addMenu"}]});return this.context_menu},create_left:function(){var e=this;if(!this.tree_store){this.tree_store=Ext.create("Ext.data.TreeStore",{fields:[{name:"parentId",type:"string",defaultValue:null},{name:"index",type:"int",defaultValue:null,persist:false},{name:"depth",type:"int",defaultValue:0,persist:false},{name:"expanded",type:"bool",defaultValue:false,persist:false},{name:"expandable",type:"bool",defaultValue:true,persist:false},{name:"leaf",type:"bool",defaultValue:false},{name:"cls",type:"string",defaultValue:null,persist:false},{name:"iconCls",type:"string",defaultValue:null,persist:false},{name:"icon",type:"string",defaultValue:null,persist:false},{name:"root",type:"boolean",defaultValue:false,persist:false},{name:"isLast",type:"boolean",defaultValue:false,persist:false},{name:"isFirst",type:"boolean",defaultValue:false,persist:false},{name:"allowDrop",type:"boolean",defaultValue:true,persist:false},{name:"allowDrag",type:"boolean",defaultValue:true,persist:false},{name:"loaded",type:"boolean",defaultValue:false,persist:false},{name:"loading",type:"boolean",defaultValue:false,persist:false},{name:"href",type:"string",defaultValue:null,persist:false},{name:"hrefTarget",type:"string",defaultValue:null,persist:false},{name:"qtip",type:"string",defaultValue:null,persist:false},{name:"qtitle",type:"string",defaultValue:null,persist:false},{name:"children",type:"auto",defaultValue:null,persist:false},{name:"description",type:"string"},{name:"text",type:"string"},{name:"code",type:"string"},{name:"type",type:"string"},{name:"id",type:"string"},{name:"url",type:"string"},{name:"resourceIds",type:"string"}],proxy:{type:"ajax",url:path("/userRole/tree.json")},root:{text:"角色列表",id:"0",expanded:true}})}if(!this.tree_panel){function f(){return function(g,j,i,h){var k;if(!d.currentNode){var l=j.childNodes;if(l.length==0){return}else{k=l[0].data}}else{k=d.currentNode}e.setEditForm_Values(k)}}this.tree_panel=Ext.create("Ext.tree.Panel",{store:this.tree_store,rootVisible:false,useArrows:true,frame:true,rootVisible:true,autoWidth:true,autoHeight:true,lines:true,animate:true,listeners:{itemclick:e.showItemAction(),itemcontextmenu:e.showMenusAction(),load:f()}})}return this.tree_panel},showMenusAction:function(){return function(i,f,j,g,k,h){k.stopEvent();return false}},setEditForm_Values:function(g){var i=Ext.getCmp("operationRegion");var f=Ext.getCmp("edit");var h;if(f&&f.isVisible()){h=this.create_display();i.removeAll(false);i.add(h);i.doLayout()}else{h=Ext.getCmp("display")}var e=h.getForm();if(g){e.setValues(g)}this.setSelectedResourceTree(h)},showItemAction:function(){var e=this;return function(i,f,j,g,l,h){var k=f.data;if(k.root){return}e.setEditForm_Values(k)}},setSelectedResourceTree:function(e,i){var h=e.getForm();if(h.findField("resourceIds")){var g=h.findField("resourceIds").getValue();if(g){this.ids=g.split(",")}else{this.ids=""}}var f=this;this.resource_tree.getRootNode().cascadeBy(function(){var j=this;var k=j.data.id;j.set("checked",false);if(f.ids&&f.ids.length>0&&!i){Ext.each(f.ids,function(l,m){if(k===l){j.set("checked",true)}})}})},loadAction:function(){var e=this;return function(){e.setSelectedResourceTree(Ext.getCmp("display"))}},create_resource_tree:function(){var e=this;if(!this.resource_tree){this.resource_tree_store=Ext.create("Ext.data.TreeStore",{fields:e.resourceFields,proxy:{type:"ajax",url:path("/userRoleResource/tree.json")},autoLoad:false,root:{text:"角色权限",id:"0",expanded:true}});this.resource_tree=Ext.create("Ext.tree.Panel",{id:"edit_tree",store:this.resource_tree_store,border:false,rootVisible:false,useArrows:true,frame:true,rootVisible:true,autoWidth:true,autoHeight:true,lines:true,animate:true,listeners:{checkchange:e.selectAction(),load:e.loadAction()}})}return this.resource_tree},selectAction:function(){return function(f,e){f.cascadeBy(function(){this.set("checked",e)});f.bubble(function(){var h=false;if(f.raw.parentId!="0"&&this.raw.parentId=="0"){var g=f.parentNode.childNodes;Ext.each(g,function(i){if(i.data.checked){h=true;return false}});this.set("checked",h||e);return false}})}},resetResourceTree:function(){var e=Ext.getCmp("treeRegion");if(e){if(e.items.length>0){e.removeAll(false)}e.add(this.create_resource_tree())}},create_display:function(){var e=this;if(!this.display_panel){function h(i){return function(){var k=Ext.getCmp("operationRegion");k.removeAll(false);var j=i.create_edit();k.add(j);k.doLayout();i.setSelectedResourceTree(j,true)}}function g(i){return function(){var m=Ext.getCmp("operationRegion");var l=Ext.getCmp("display");var j=l.getForm().getFieldValues();m.removeAll(false);var k=i.create_edit(j);m.add(k);m.doLayout();i.setSelectedResourceTree(k)}}function f(k){var i=function(l){return function(p,s){var q=p.responseText;var n=Ext.JSON.decode(q);var m=n.result;if(m&&m!=="SUCCESS"){msg="该角色由用户"+m+"引用，如需删除该角色，请先删除该用户!";Ext.MessageBox.alert("提示",msg)}else{Ext.MessageBox.confirm("警告","确定删除?",function(o){if(o=="yes"){j(l)}})}}};function j(m){function l(){return function(p){var q=p.responseText;var o=Ext.JSON.decode(q);var n=o.result;if(n===true){d.tree_store.load()}else{Ext.MessageBox.alert("提示",n)}}}Ext.Ajax.request({url:path("/userRole/remove"),params:{id:m},method:"GET",success:l()})}return function(){var m=Ext.getCmp("display");var l=m.getForm();if(l){var n=l.findField("id").getValue();Ext.Ajax.request({url:path("/userRole/checkResource"),params:{id:n},method:"GET",success:i(n)})}}}this.display_panel=Ext.create("Ext.form.Panel",{id:"display",cls:"exception-right",frame:true,border:true,fieldDefaults:{anchor:"100%"},autoScroll:true,model:Ext.create("TreeForm"),dockedItems:[{xtype:"toolbar",height:40,dock:"top",items:[{text:"新增",handler:h(e)},{text:"编辑",handler:g(e)},{text:"删除",handler:f(e)}]}],items:[{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"resourceIds"},{xtype:"hiddenfield",fieldLabel:"角色编码",name:"code",allowBlank:false},{xtype:"displayfield",fieldLabel:"角色名称",name:"text",allowBlank:false},{xtype:"displayfield",fieldLabel:"角色描述",name:"description"},{xtype:"fieldset",id:"treeRegion",layout:"fit",height:"100%",border:false}]})}this.resetResourceTree();return this.display_panel},create_edit:function(i){var f=this;if(!this.form_panel){var h=function(){return function(){var n=f.form_panel.getForm();var j=f.resource_tree.getChecked();var o="";if(j.length>0){var m;for(var l=0,k=j.length;l<k;l++){m=j[l];if(!m||!m.data){continue}o+=m.data.id;if(l!=k-1){o+=","}}}n.setValues({resourceIds:o});if(!n.isValid()){Ext.Msg.alert("提示","请检查您输入的数据");return}d.currentNode=null;n.submit({clientValidation:true,waitMsgTarget:"正在提交...",waitTitle:"请稍候",url:path("/user/mergeRole"),success:function(q,r){var p=r.result.result;if(p.error=="RoleNameError"){Ext.Msg.alert(messages["ext.tips.error"],"角色名称已存在！");return}else{if(p.success){q.reset();d.currentNode=p.role;f.tree_store.load()}else{Ext.Msg.alert("提示","提交有误")}}},failure:function(p,q){}})}};var g=function(j){return function(){var l=Ext.getCmp("operationRegion");l.removeAll(false);var k=j.create_display();l.add(k);l.doLayout();f.setSelectedResourceTree(k)}};this.form_panel=Ext.create("Ext.form.Panel",{id:"edit",cls:"exception-right",frame:true,border:true,fieldDefaults:{anchor:"100%"},autoScroll:true,model:Ext.create("TreeForm"),dockedItems:[{xtype:"toolbar",height:40,dock:"top",items:[{text:"确定",handler:h()},{text:"取消",handler:g(f)}]}],items:[{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"resourceIds"},{xtype:"hiddenfield",fieldLabel:"角色编码",name:"code",allowBlank:false},{xtype:"textfield",fieldLabel:"角色名称",name:"text",allowBlank:false},{xtype:"textfield",fieldLabel:"角色描述",name:"description"},{xtype:"fieldset",id:"treeRegion",layout:"fit",height:"100%"}]})}else{this.form_panel.getForm().reset()}this.resetResourceTree();var e=this.form_panel.getForm();if(i){e.setValues(i)}return this.form_panel},create_right:function(){return this.create_display()},create_index:function(){var g=this;var f=Ext.getCmp("center");var e=f.getHeight();return Ext.create("Ext.panel.Panel",{border:false,layout:"column",defaults:{layout:"anchor",defaults:{anchor:"100%"}},items:[{xtype:"panel",columnWidth:1/3,layout:"fit",height:e,items:g.create_left()},{xtype:"panel",id:"operationRegion",columnWidth:2/3,layout:"fit",height:e,items:g.create_right()}]})}};function b(){d.define();var e={createIndex:function(){return d.create_index()}};return e}$UserRole=b()})(this);Ext.onReady(function(){var a=$UserRole.createIndex();Ext.getCmp("center").add(a)});
(function(b){var d=b.$UserRoleResource;var c={define:function(){Ext.define("TreeForm",{extend:"Ext.data.Model",fields:[{name:"description",type:"string"},{name:"text",type:"string"},{name:"code",type:"string"},{name:"type",type:"string"},{name:"url",type:"string"},{name:"parentId",type:"string"},{name:"id",type:"string"},{name:"url",type:"string"}],proxy:{type:"memory",reader:{type:"json"}}});this.typeStore=Ext.create("Ext.data.Store",{fields:["val","name"],data:[{val:"ajax",name:"异步资源"},{val:"sync",name:"同步资源"}]})},addMenuByParentId:function(f){var e=this.tree_store;return function(){var j=Ext.getCmp("display");var i=Ext.getCmp("edit");var k=Ext.getCmp("operationRegion");i=!i?c.create_edit():i;if(j.isVisible()){k.remove(j,false)}k.add(i);k.doLayout();var h=i.getForm();if(h){h.reset();var g="";if(f!==0){g=e.getNodeById(f).data.text}h.setValues({parentId_name:g,parentId:f})}}},create_menu:function(g){var f=this;var i=g.data;var e=i.root;var h=[{text:"子级",handler:f.addMenuByParentId(i.id)}];if(!e){h.push({text:"同级",handler:f.addMenuByParentId(i.parentId)})}this.context_menu=Ext.create("Ext.menu.Menu",{items:[{iconCls:"buy-button",text:"添加",id:"addMenu",menu:{items:h}}]});this.context_menu.node=g;return this.context_menu},create_left:function(){var e=this;if(!this.tree_store){this.tree_store=Ext.create("Ext.data.TreeStore",{fields:[{name:"parentId",type:"string",defaultValue:null},{name:"index",type:"int",defaultValue:null,persist:false},{name:"depth",type:"int",defaultValue:0,persist:false},{name:"expanded",type:"bool",defaultValue:false,persist:false},{name:"expandable",type:"bool",defaultValue:true,persist:false},{name:"leaf",type:"bool",defaultValue:false},{name:"cls",type:"string",defaultValue:null,persist:false},{name:"iconCls",type:"string",defaultValue:null,persist:false},{name:"icon",type:"string",defaultValue:null,persist:false},{name:"root",type:"boolean",defaultValue:false,persist:false},{name:"isLast",type:"boolean",defaultValue:false,persist:false},{name:"isFirst",type:"boolean",defaultValue:false,persist:false},{name:"allowDrop",type:"boolean",defaultValue:true,persist:false},{name:"allowDrag",type:"boolean",defaultValue:true,persist:false},{name:"loaded",type:"boolean",defaultValue:false,persist:false},{name:"loading",type:"boolean",defaultValue:false,persist:false},{name:"href",type:"string",defaultValue:null,persist:false},{name:"hrefTarget",type:"string",defaultValue:null,persist:false},{name:"qtip",type:"string",defaultValue:null,persist:false},{name:"qtitle",type:"string",defaultValue:null,persist:false},{name:"children",type:"auto",defaultValue:null,persist:false},{name:"description",type:"string"},{name:"text",type:"string"},{name:"code",type:"string"},{name:"type",type:"string"},{name:"id",type:"string"},{name:"url",type:"string"}],proxy:{type:"ajax",url:path("/userRoleResource/tree.json")},root:{text:"资源列表",id:"0",expanded:true}})}if(!this.tree_panel){function f(){return function(g,j,i,h){var k;if(!c.currentNode){var l=j.childNodes;if(l.length==0){return}else{k=l[0].data}}else{k=c.currentNode}e.setEditForm_Values(k)}}this.tree_panel=Ext.create("Ext.tree.Panel",{store:this.tree_store,rootVisible:false,useArrows:true,frame:true,rootVisible:true,autoWidth:true,autoHeight:true,lines:true,animate:true,listeners:{itemclick:e.showItemAction(),itemcontextmenu:e.showMenusAction(),load:f()}})}return this.tree_panel},showMenusAction:function(){return function(i,f,j,g,k,h){k.stopEvent();return false}},setEditForm_Values:function(h){var e=this.tree_store;var p=this.typeStore;var f=Ext.getCmp("edit");var o=Ext.getCmp("display");var j=Ext.getCmp("operationRegion");var o;if(f&&f.isVisible()){o=this.create_display();j.remove(f,false);j.add(o)}else{o=Ext.getCmp("display")}var n=o.getForm();if(h){var k=h.parentId;var m="";if(k!=0){var g=e.getNodeById(k).data;m=g.text}h.parentId_name=m;var l=h.type;var i=p.findRecord("val",l);h.type_name=i.get("name");n.setValues(h)}},showItemAction:function(){var e=this;return function(i,f,j,g,l,h){var k=f.data;if(k.root){return}e.setEditForm_Values(k)}},create_display:function(){var e=this;if(!this.display_panel){function h(i){return function(){var k=Ext.getCmp("operationRegion");var j=Ext.getCmp("display");k.remove(j,false);k.add(i.create_edit());k.doLayout()}}function g(i){return function(){var n=Ext.getCmp("operationRegion");var m=Ext.getCmp("display");var k=m.getForm();var j=k.getFieldValues();n.remove(m,false);var l=i.create_edit();n.add(l);n.doLayout();if(l){l.getForm().setValues(j)}}}var f=function(){var i=function(k){return function(n,q){var p=n.responseText;var m=Ext.JSON.decode(p);var l=m.result;if(l&&l!=="SUCCESS"){msg="该资源由角色<br/>"+l+"引用，确定删除？"}else{msg="确定删除？"}Ext.MessageBox.confirm("警告",msg,function(o){if(o=="yes"){j(k)}})}};function j(l){function k(){return function(o){var p=o.responseText;var n=Ext.JSON.decode(p);var m=n.result;if(m===true){c.tree_store.load()}else{Ext.MessageBox.alert("提示",m)}}}Ext.Ajax.request({url:path("/userRoleResource/remove"),params:{id:l},method:"GET",success:k()})}return function(){var l=Ext.getCmp("display");var k=l.getForm();if(k){var m=k.findField("id").getValue();Ext.Ajax.request({url:path("/userRoleResource/checkResource"),params:{id:m},method:"GET",success:i(m)})}}};this.display_panel=Ext.create("Ext.form.Panel",{id:"display",cls:"exception-right",frame:true,border:true,fieldDefaults:{anchor:"100%"},autoScroll:true,model:Ext.create("TreeForm"),items:[{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"parentId"},{xtype:"displayfield",fieldLabel:"所属资源",name:"parentId_name"},{xtype:"hiddenfield",name:"type"},{xtype:"hiddenfield",fieldLabel:"资源类型",name:"type_name"},{xtype:"displayfield",fieldLabel:"资源名称",name:"text"},{xtype:"hiddenfield",fieldLabel:"资源编码",name:"code"},{xtype:"displayfield",fieldLabel:"资源URL",name:"url"},{xtype:"displayfield",fieldLabel:"描述",name:"description"}]})}return this.display_panel},create_edit:function(){var e=this;if(!this.form_panel){var g=function(){return function(){var h=e.form_panel.getForm();if(!h.isValid()){Ext.Msg.alert("提示","请检查您输入的数据");return}c.currentNode=null;h.submit({clientValidation:true,waitMsgTarget:"正在提交...",waitTitle:"请稍候",url:path("/user/addNewResource"),success:function(j,k){var i=k.result.result;if(i.success){j.reset();c.currentNode=i.resource;e.tree_store.load()}else{Ext.Msg.alert("提示","提交有误")}},failure:function(i,j){}})}};var f=function(h){return function(){var j=Ext.getCmp("operationRegion");var i=Ext.getCmp("edit");j.remove(i,false);j.add(h.create_display());j.doLayout()}};this.form_panel=Ext.create("Ext.form.Panel",{id:"edit",cls:"exception-right",frame:true,border:true,fieldDefaults:{anchor:"100%"},autoScroll:true,model:Ext.create("TreeForm"),dockedItems:[{xtype:"toolbar",height:40,dock:"top",items:[{text:"确定",handler:g()},{text:"取消",handler:f(e)}]}],items:[{xtype:"hiddenfield",name:"id"},{xtype:"hiddenfield",name:"parentId"},{xtype:"textfield",fieldLabel:"所属资源",name:"parentId_name",readOnly:true},{xtype:"hiddenfield",fieldLabel:"资源类型",name:"type",value:"sync"},{xtype:"textfield",fieldLabel:"资源名称",name:"text",allowBlank:false},{xtype:"textfield",fieldLabel:"资源编码",name:"code",allowBlank:false},{xtype:"textfield",fieldLabel:"资源URL",name:"url",allowBlank:false,defaultValue:"#"},{xtype:"textareafield",fieldLabel:"描述",name:"description"}]})}return this.form_panel},create_right:function(){return this.create_display()},create_index:function(){var g=this;var f=Ext.getCmp("center");var e=f.getHeight();return Ext.create("Ext.panel.Panel",{border:false,layout:"column",defaults:{layout:"anchor",defaults:{anchor:"100%"}},items:[{xtype:"panel",columnWidth:1/2,layout:"fit",height:e,items:g.create_left()},{xtype:"panel",id:"operationRegion",columnWidth:1/2,layout:"fit",height:e,items:g.create_right()}]})}};function a(){c.define();var e={createIndex:function(){return c.create_index()}};return e}$UserRoleResource=a()})(this);Ext.onReady(function(){var a=$UserRoleResource.createIndex();Ext.getCmp("center").add(a)});
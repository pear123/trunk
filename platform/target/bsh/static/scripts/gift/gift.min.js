(function(a){var b=a.$Gift;var c={define:function(){var e=Ext.create("Ext.data.Store",{fields:["value","label"],proxy:{type:"ajax",url:path("/gift/findBrand.json"),reader:{type:"json",root:"result"}},autoLoad:true});Ext.define("Smartec.gift.GiftGrid",{extend:"Smartec.grid.Panel",model:"Gift",id:"giftGridId",columns:[{xtype:"rownumberer",text:"序号",width:40,sortable:false},{text:"id",dataIndex:"skuId",hidden:true},{text:"版本",dataIndex:"version",hidden:true},{text:"品牌",width:150,sortable:true,dataIndex:"brand"},{text:"SAP物料号",width:150,sortable:true,dataIndex:"skuNo"},{text:"商品名称",width:250,sortable:true,dataIndex:"name"},{text:"客服备注简写",width:150,sortable:true,dataIndex:"memo"},{text:"状态",width:130,sortable:true,dataIndex:"status"}],addGift:function(f){return function(){Ext.Ajax.request({url:path("/gift/doCurrentOperation.json?operationType=save"),method:"post",dataType:"json",success:function(j,g){var i=Ext.decode(j.responseText);if(i.success){var h=f.up("gridpanel");if(Ext.getCmp("addGiftWindow")){Ext.getCmp("addGiftWindow").show(this)}else{Ext.create("Ext.Window",{title:"添加物料",width:450,height:300,layout:"fit",draggable:true,maximizable:true,modal:true,id:"addGiftWindow",listeners:{hide:function(l){var k=Ext.getCmp("addGiftForm").getForm();k.clearInvalid();k.reset()}},items:[new Ext.form.FormPanel({id:"addGiftForm",bodyPadding:20,autoScroll:true,items:[{xtype:"combo",fieldLabel:"品牌",typeAhead:true,name:"brand",store:e,displayField:"label",valueField:"value",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",width:300,queryMode:"local",forceSelection:true,typeAhead:true,listeners:{beforequery:function(n){var m=n.combo;if(!n.forceAll){var k=n.query;var l=new RegExp(".*"+k+".*");m.store.filterBy(function(o,q){var p=o.get(m.displayField);return l.test(p)});m.expand();return false}}}},{xtype:"textfield",fieldLabel:"SAP物料号",name:"skuNo",id:"skuNo",padding:"0 0 15 0",allowBlank:false,blankText:"不能为空",maxLength:50,maxLengthText:"最大长度不能超过50个字符!",width:300,regex:/^[A-Za-z0-9]+$/,regexText:"错误,SAP物料号只能由数字和字母组成",listeners:{blur:function(){var k=Ext.getCmp("skuNo").getValue();Ext.Ajax.request({url:path("/gift/findSkuNo.json?inputSkuNo="+k),method:"post",dataType:"json",success:function(n,l){var m=Ext.decode(n.responseText);if(m.success){}else{Ext.Msg.alert("提示信息","SKU号错误:"+m.result);Ext.getCmp("skuNo").setValue()==""}},failure:function(m,l){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})}}},{xtype:"textfield",fieldLabel:"商品名称",name:"name",allowDecimals:true,decimalPrecision:2,padding:"0 0 15 0",allowBlank:false,blankText:"不能为空",minValue:0,width:300},{fieldLabel:"客服备注简写",xtype:"textfield",name:"memo",allowBlank:false,blankText:"不能为空",padding:"0 0 15 0",allowDecimals:true,decimalPrecision:2,minValue:0,width:300},{xtype:"button",text:"保存",iconCls:"icon-ok",handler:f.saveGift}]})]}).show()}Ext.getCmp("addGiftWindow").on("close",function(){Ext.Ajax.request({url:path("/gift/doDeleteCurrentOperation.json?operationType=save"),method:"post",dataType:"json",success:function(l,k){}})})}else{Ext.Msg.alert("提示信息",i.result)}}})}},saveGift:function(){var f=Ext.getCmp("addGiftForm").getForm();if(f.isValid()){f.submit({url:path("/gift/saveGift.json?operationType=save"),method:"POST",success:function(i,h){Ext.Msg.alert("提示信息","保存成功");Ext.getCmp("addGiftWindow").close();var g=Ext.getCmp("giftGridId");g.getStore().load()},failure:function(i,h){var g=Ext.decode(h.response.responseText);console.info(g);Ext.Msg.alert("提示信息","保存失败:"+g.result)},waitTitle:Ext.MessageBox.wait("正在保存，请等待...","提示")})}else{Ext.Msg.alert("提示信息","请输入正确的值！")}},deleteGift:function(j){var h=this.up("gridpanel");var l=h.getSelectionModel();var f=l.getSelection();if(!(f.length>=1)){Ext.Msg.alert("错误","没有任何行被选中，无法进行删除操作！");return}else{var k="";for(var g=0;g<f.length;g++){console.info(f[g].data.skuId);k=k+f[g].data.skuId+";"}Ext.Ajax.request({url:path("/gift/doCurrentOperation.json?operationType=delete&id="+k),method:"post",dataType:"json",success:function(o,i){var m=Ext.decode(o.responseText);if(m.success){Ext.MessageBox.confirm({title:"警告",msg:"确定要删除吗?",closable:false,buttons:Ext.Msg.YESNO,fn:n,icon:Ext.Msg.INFO});function n(p){if(p=="yes"){Ext.Ajax.request({url:path("/gift/deleteGift.json?id="+k),method:"post",success:function(s,r){Ext.Msg.alert("提示信息","删除成功");var q=Ext.getCmp("giftGridId");q.getStore().load()},failure:function(r,q){Ext.Msg.alert("提示信息","删除失败")},waitTitle:Ext.MessageBox.wait("正在保存，请等待...","提示")})}else{if(p=="no"){Ext.Ajax.request({url:path("/gift/doDeleteCurrentOperation.json?operationType=delete"),method:"post",dataType:"json",success:function(r,q){}})}}}}else{Ext.Msg.alert("提示信息",m.result)}},failure:function(m,i){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})}},modifyGift:function(j){var i=this.up("gridpanel");var k=i.getSelectionModel();var h=k.getSelection();if(h.length==0){Ext.Msg.alert("提示","请选择一条记录进行修改！");return}if(h.length!=1){Ext.Msg.alert("提示","只能选择一条记录进行修改！");return}var g=k.getSelection()[0];var f=g.get("skuId");Ext.Ajax.request({url:path("/gift/doCurrentOperation.json?operationType=modify&sysId="+f),method:"post",dataType:"json",success:function(n,l){var m=Ext.decode(n.responseText);if(m.success){if(Ext.getCmp("editGiftWindow")){Ext.getCmp("editGiftWindow").show()}else{Ext.create("Ext.Window",{title:"修改物料",width:450,height:300,layout:"fit",draggable:false,maximizable:true,modal:true,id:"editGiftWindow",items:[Ext.create("Ext.form.Panel",{url:path("/gift/findById.json?id="+f),id:"editGiftForm",reader:new Ext.data.JsonReader({root:"result",model:"Gift",successProperty:"success"}),bodyPadding:20,autoScroll:true,items:[{xtype:"combo",fieldLabel:"品牌",typeAhead:true,id:"brandCom",name:"brand",store:e,displayField:"label",valueField:"value",padding:"0 0 10 0",allowBlank:false,blankText:"不能为空",value:g.get("brand"),width:300,queryMode:"local",forceSelection:true,typeAhead:true,listeners:{beforequery:function(r){var q=r.combo;if(!r.forceAll){var o=r.query;var p=new RegExp(".*"+o+".*");q.store.filterBy(function(s,u){var t=s.get(q.displayField);return p.test(t)});q.expand();return false}}}},{xtype:"textfield",fieldLabel:"SAP物料号",id:"skuNo",name:"skuNo",padding:"0 0 15 0",allowBlank:false,blankText:"不能为空",value:g.get("skuNo"),maxLength:50,maxLengthText:"最大长度不能超过50个字符!",width:300,regex:/^[A-Za-z0-9]+$/,regexText:"错误,SAP物料号只能由数字和字母组成",listeners:{blur:function(){var o=Ext.getCmp("skuNo").getValue();var p=g.get("skuNo");Ext.Ajax.request({url:path("/gift/findSkuNoRemoveMy.json?inputSkuNo="+o+"&recordSkuNo="+p),method:"post",dataType:"json",success:function(s,q){var r=Ext.decode(s.responseText);if(r.success){}else{Ext.Msg.alert("提示信息","SKU号错误:"+r.result)}},failure:function(r,q){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})}}},{xtype:"textfield",fieldLabel:"商品名称",name:"name",value:g.get("name"),allowDecimals:true,padding:"0 0 15 0",maxLength:100,decimalPrecision:2,minValue:0,width:300},{fieldLabel:"客服备注简写",xtype:"textfield",name:"memo",value:g.get("memo"),allowDecimals:true,padding:"0 0 15 0",decimalPrecision:2,minValue:0,width:300},{xtype:"fieldcontainer",layout:"hbox",items:[{xtype:"button",text:"保存",iconCls:"icon-ok",handler:function(){var o=Ext.getCmp("editGiftForm").getForm();var p=g.get("skuNo");if(this.up("panel").getForm().isValid()){this.up("panel").getForm().submit({url:path("/gift/saveGift.json?operationType=modify&skuId="+f+"&recordSkuNo="+p),success:function(s,r){Ext.Msg.alert("提示信息","保存成功");Ext.getCmp("editGiftWindow").close();var q=Ext.getCmp("giftGridId");q.getStore().load()},failure:function(t,s){var r=Ext.decode(s.response.responseText);Ext.Msg.alert("提示信息","保存失败:"+r.result);if("该记录已被删除"==r.result){Ext.getCmp("editGiftWindow").close();var q=Ext.getCmp("giftGridId");q.getStore().load()}},waitTitle:Ext.MessageBox.wait("正在保存，请等待...","提示")})}else{Ext.Msg.alert(messages["ext.tips.error"],"填写的内容有误!")}}}]}]})]}).show()}Ext.getCmp("editGiftWindow").on("close",function(){Ext.Ajax.request({url:path("/gift/doDeleteCurrentOperation.json?operationType=modify&sysId="+f),method:"post",dataType:"json",success:function(p,o){}})})}else{Ext.Msg.alert("提示信息",m.result)}},failure:function(m,l){Ext.Msg.alert("提示信息","请求失败,请稍后再试")}})},unlockGift:function(f){Ext.Ajax.request({url:path("/gift/doDeleteGiftCurrentOperationByUser.json"),method:"post",dataType:"json",success:function(i,g){var h=Ext.decode(i.responseText);Ext.Msg.alert("提示信息",h.result)}})},initComponent:function(){var f=this;f.topDockedItems=[{xtype:"button",itemId:"btnSearch",height:24,text:"重置查询",iconCls:"icon-edit",handler:c.clearFilters()},{xtype:"button",itemId:"btnAdd",height:24,text:"添加",iconCls:"icon-edit",handler:f.addGift(this)},{xtype:"button",itemId:"btnEdit",height:24,text:"修改",disable:true,iconCls:"icon-edit",handler:f.modifyGift},{xtype:"button",itemId:"btnDelete",height:24,text:"删除",disable:true,iconCls:"icon-edit",handler:f.deleteGift},{xtype:"button",itemId:"btnUnlocek",height:24,text:"解锁",disable:true,iconCls:"icon-edit",handler:f.unlockGift}];f.callParent();f.getSelectionModel().on("selectionchange",function(h,g){})}})},clearFilters:function(){var e=this;return function(){if(e.gift_grid){e.gift_grid.filters.clearFilters()}}},init_filters:function(){return[{type:"string",dataIndex:"brand"},{type:"string",dataIndex:"skuNo"},{type:"string",dataIndex:"name"},{type:"string",dataIndex:"memo"},{type:"string",dataIndex:"status"},{type:"numeric",dataIndex:"version"}]},create_grid:function(){if(!this.gift_grid){this.gift_grid=Ext.create("Smartec.gift.GiftGrid",{topBarHight:30,id:"giftGridId",autoHeight:true,autoWidth:true,autoAdded:false,autoSetStore:true,features:[{ftype:"filters",encode:true,local:false,menuFilterText:messages["ext.filters.menuFilterText"],filters:c.init_filters()}]})}return this.gift_grid}};function d(){c.define();var e={createGrid:function(){return c.create_grid()}};return e}a.$Gift=d()})(this);Ext.onReady(function(){var a=$Gift.createGrid();Ext.getCmp("center").add(a)});
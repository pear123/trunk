(function(e){var b=e.$SaleStructurePage;var a={define:function(){Ext.require(["Ext.form.*","Ext.Img","Ext.tip.QuickTipManager","Ext.ux.FieldReplicator"]);Ext.define("Bsh.report.saleStructure.IndexView",{extend:"Ext.form.Panel",clearAll:function(g){return function(){g.getForm().reset()}},addExportTab:function(g){return function(){var l=Ext.getCmp("mainTab1");if(l){if(Ext.getCmp("saleStructurePageId")){var k=Ext.getCmp("saleStructurePageId").getStore();var i=Ext.getCmp("category").getValue();var p=Ext.getCmp("storeId").getValue();var j=Ext.getCmp("startTime").getRawValue();var m=Ext.getCmp("endTime").getRawValue();var h=Ext.getCmp("is_trade_close").checked;var n=Ext.getCmp("sku").getRawValue();new_params={category1:i,storeId1:p,startTime1:j,endTime1:m,is_trade_close1:h,sku1:n};Ext.apply(k.proxy.extraParams,new_params);k.load();k.on("load",function(r,q,s){if(q.length==0){Ext.Msg.alert("提示信息","无记录!")}else{l.setActiveTab(1);l.show()}})}else{var o=a.create_grid();o.store.on("load",function(r,q,s){if(q.length==0){Ext.Msg.alert("提示信息","无记录!")}else{l.add(o).show()}})}}}},initComponent:function(){var g=this;this.dockedItems=[{xtype:"toolbar",dock:"top",items:[{xtype:"button",itemId:"btnEdit",text:"查询",handler:g.addExportTab(this)},{xtype:"button",iconCls:"icon-clearAll",text:"清空",handler:g.clearAll(this)}]}];g.callParent()}});Ext.define("Smartec.page.SaleStructure",{extend:"Smartec.reportGrid.Panel",title:"结果展示",model:SaleStructurePage,columns:[{text:"No",width:100,sortable:false,dataIndex:"num"},{text:"VIB",width:100,sortable:false,dataIndex:"matnr"},{text:"QTY",width:100,sortable:false,dataIndex:"saleQuantity"},{text:"Value",width:100,sortable:false,dataIndex:"saleAmount"},{text:"AVP",width:100,sortable:false,dataIndex:"saleAvg"},{text:"Qty Share",width:100,sortable:false,dataIndex:"saleQuantityPercentage"},{text:"Value Share",width:100,sortable:false,dataIndex:"saleAmountPercentage"},{text:"Supply Price",width:100,sortable:false,dataIndex:"sapPrice"},{text:"Orignal Value",width:100,sortable:false,dataIndex:"sapAmount"},{text:"Discount Rate",width:100,sortable:false,dataIndex:"sapDiscount"}],exportExcel:function(){var g=new Ext.LoadMask(document.body,{msg:"正在导出，请稍候",removeMask:true});g.show();Ext.Ajax.request({disableCaching:true,url:path("/sale/generateSaleStructure.json"),method:"POST",params:{category1:Ext.getCmp("category").getValue(),storeId1:Ext.getCmp("storeId").getValue(),startTime1:Ext.getCmp("startTime").getRawValue(),endTime1:Ext.getCmp("endTime").getRawValue(),is_trade_close1:Ext.getCmp("is_trade_close").checked,sku1:Ext.getCmp("sku").getRawValue()},success:function(h){if(""==Ext.decode(h.responseText).result){Ext.Msg.alert("提示信息","无纪录！")}if("none"==Ext.decode(h.responseText).result){Ext.Msg.alert("提示信息","无纪录！")}else{window.location.href=path("/sale/downSaleStructure.json?filePath="+Ext.decode(h.responseText).result)}g.hide()},failure:function(h){g.hide()},timeout:600000})},initComponent:function(){var g=this;g.topDockedItems=[{xtype:"button",itemId:"btnEdit",height:24,text:"导出",iconCls:"icon-edit",handler:g.exportExcel}];g.callParent();g.store.on("beforeload",function(j,k){var m=Ext.getCmp("category").getValue();var h=Ext.getCmp("storeId").getValue();var l=Ext.getCmp("startTime").getRawValue();var i=Ext.getCmp("endTime").getRawValue();var o=Ext.getCmp("is_trade_close").checked;var n=Ext.getCmp("sku").getRawValue();new_params={category1:m,storeId1:h,startTime1:l,endTime1:i,is_trade_close1:o,sku1:n};Ext.apply(j.proxy.extraParams,new_params)})}})},create_grid:function(){return Ext.create("Smartec.page.SaleStructure",{id:"saleStructurePageId",topBarHight:30,autoHeight:true,autoWidth:true,autoAdded:false,autoSetStore:true,closable:true,closeAction:"hide"})},create_index:function(){if(!this.mainTabPanel){var g=Ext.create("Bsh.report.saleStructure.IndexView",{id:"indexView",plain:true,border:0,bodyPadding:"20px 50px 100px 20px",fieldDefaults:{labelWidth:120,padding:"10px 0 0 0"},items:[{xtype:"combo",fieldLabel:"品类",emptyText:"请选择...",emptyValue:"",typeAhead:true,name:"category",id:"category",store:f,displayField:"label",valueField:"value",padding:"0 0 10 0",width:300,queryMode:"local",forceSelection:true,typeAhead:true,listeners:{beforequery:function(k){var j=k.combo;if(!k.forceAll){var h=k.query;var i=new RegExp(".*"+h+".*");j.store.filterBy(function(l,n){var m=l.get(j.displayField);return i.test(m)});j.expand();return false}}}},{xtype:"combo",name:"storeId",id:"storeId",anchor:"30%",fieldLabel:"商家店铺",store:d,displayField:"label",valueField:"value"},{xtype:"datefield",name:"startTime",id:"startTime",fieldLabel:"开始时间",anchor:"30%",style:"margin-top:15px",format:"Y-m-d H:i:s",listeners:{select:function(h){Ext.getCmp("endTime").setMinValue(h.getValue())}}},{xtype:"datefield",name:"endTime",id:"endTime",fieldLabel:"结束时间",labelSeparator:"",anchor:"30%",format:"Y-m-d H:i:s",listeners:{select:function(k,j,i){var h=Ext.Date.add(new Date(this.value),Ext.Date.HOUR,23);h=Ext.Date.add(new Date(h),Ext.Date.MINUTE,59);h=Ext.Date.add(new Date(h),Ext.Date.SECOND,59);this.setValue(h);Ext.getCmp("startTime").setMaxValue(h)}}},{fieldLabel:"不包含交易关闭",xtype:"checkbox",name:"is_trade_close",id:"is_trade_close"},{fieldLabel:"SKU",xtype:"textfield",name:"sku",id:"sku"}]});this.mainTabPanel=Ext.create("Ext.tab.Panel",{id:"mainTab1",activeTab:0,autoHeight:true,layout:"fit",items:[{items:g,title:"销售结构分析查询"}]})}return this.mainTabPanel}};var d=Ext.create("Ext.data.Store",{fields:["label","value"],data:[{label:"西门子",value:"22511900"},{label:"博世",value:"22511920"}]});var f=Ext.create("Ext.data.Store",{fields:["value","label"],proxy:{type:"ajax",url:path("/sku/findCategory.json"),reader:{type:"json",root:"result"}},autoLoad:true});function c(){a.define();var g={createIndex:function(){return a.create_index()}};return g}e.$SaleStructurePage=c()})(this);Ext.onReady(function(){Ext.tip.QuickTipManager.init();var a=$SaleStructurePage.createIndex();Ext.getCmp("center").add(a);Ext.getBody().insertHtml("beforeEnd",'<form action="/bsh/sale/downSaleStructure.json" id="queryForm" name = "queryForm" method="post" ><input type="hidden" name="category1" id="category1" ><input type="hidden" name="storeId1" id="storeId1"><input type="hidden" name="startTime1" id="startTime1"><input type="hidden" name="endTime1" id="endTime1"><input type="hidden" name="is_trade_close1" id="is_trade_close1"><input type="hidden" name="sku1" id="sku1"></form>')});